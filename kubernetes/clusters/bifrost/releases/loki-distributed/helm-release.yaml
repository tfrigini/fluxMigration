---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki-distributed
  namespace: loki

spec:
  interval: 5m
  releaseName: loki-distributed
  targetNamespace: loki-distributed

  chart:
    spec:
      chart: loki-distributed
      version: "0.28.0"
      sourceRef:
        kind: HelmRepository
        name: loki
        namespace: flux-system
      interval: 1m

  maxHistory: 30

  values:
  
    loki:
      # Configures the readiness probe for all of the Loki pods
      readinessProbe:
        httpGet:
          path: /ready
          port: http
        initialDelaySeconds: 30
        timeoutSeconds: 1
      image:
        # -- The Docker registry
        registry: docker.io
        # -- Docker image repository
        repository: grafana/loki
        # -- Overrides the image tag whose default is the chart's appVersion
        tag: null
        # -- Docker image pull policy
        pullPolicy: IfNotPresent
      # -- Common annotations for all pods
      podAnnotations: {}
      # -- The number of old ReplicaSets to retain to allow rollback
      revisionHistoryLimit: 10
      # -- The SecurityContext for Loki pods
      podSecurityContext:
        fsGroup: 10001
        runAsGroup: 10001
        runAsNonRoot: true
        runAsUser: 10001
      # -- The SecurityContext for Loki containers
      containerSecurityContext:
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
        allowPrivilegeEscalation: false
      # -- Config file contents for Loki
      # @default -- See values.yaml
      config: |
        auth_enabled: false

        server:
          http_listen_port: 3100

        distributor:
          ring:
            kvstore:
              store: memberlist

        memberlist:
          join_members:
            - {{ include "loki.fullname" . }}-memberlist

        ingester:
          lifecycler:
            ring:
              kvstore:
                store: memberlist
              replication_factor: 3
          chunk_idle_period: 1h30m
          heartbeat_timeout: 10m
          chunk_target_size: 1572864
          chunk_block_size: 262144
          chunk_encoding: snappy
          chunk_retain_period: 1m
          max_chunk_age: 2h
          max_transfer_retries: 0

        limits_config:
          enforce_metric_name: false
          reject_old_samples: true
          reject_old_samples_max_age: 168h
          max_cache_freshness_per_query: 10m

        schema_config:
          configs:
            - from: 2020-09-07
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: loki_index_
                period: 24h

        storage_config:
          boltdb_shipper:
            shared_store: filesystem
            active_index_directory: /var/loki/index
            cache_location: /var/loki/cache
            cache_ttl: 168h
          filesystem:
            directory: /var/loki/chunks

        chunk_store_config:
          max_look_back_period: 0s

        table_manager:
          retention_deletes_enabled: false
          retention_period: 0s

        query_range:
          align_queries_with_step: true
          max_retries: 5
          split_queries_by_interval: 15m
          cache_results: true
          results_cache:
            cache:
              enable_fifocache: true
              fifocache:
                max_size_items: 1024
                validity: 24h

        frontend_worker:
          frontend_address: {{ include "loki.queryFrontendFullname" . }}:9095

        frontend:
          log_queries_longer_than: 5s
          compress_responses: true

        compactor:
          shared_store: filesystem

        ruler:
          storage:
            type: local
            local:
              directory: /etc/loki/rules
          ring:
            kvstore:
              store: memberlist
          rule_path: /tmp/loki/scratch
          alertmanager_url: https://alertmanager.xx
          external_url: https://alertmanager.xx

    # Configuration for the ingester
    ingester:
      # -- Number of replicas for the ingester
      replicas: 1
      # -- Resource requests and limits for the ingester
      resources: {}
      # -- Grace period to allow the ingester to shutdown before it is killed. Especially for the ingestor,
      # this must be increased. It must be long enough so ingesters can be gracefully shutdown flushing/transferring
      # all data and to successfully leave the member ring on shutdown.
      terminationGracePeriodSeconds: 300
      # -- Affinity for ingester pods. Passed through `tpl` and, thus, to be configured as string
      # @default -- Hard node and soft zone anti-affinity
      affinity: |
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "loki.ingesterSelectorLabels" . | nindent 10 }}
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "loki.ingesterSelectorLabels" . | nindent 12 }}
                topologyKey: failure-domain.beta.kubernetes.io/zone
      # -- Node selector for ingester pods
      nodeSelector: {}
      # -- Tolerations for ingester pods
      tolerations: []
      persistence:
        # -- Enable creating PVCs which is required when using boltdb-shipper
        enabled: false
        # -- Size of persistent disk
        size: 10Gi
        # -- Storage class to be used.
        # If defined, storageClassName: <storageClass>.
        # If set to "-", storageClassName: "", which disables dynamic provisioning.
        # If empty or set to null, no storageClassName spec is
        # set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack).
        storageClass: null

    # Configuration for the distributor
    distributor:
      # -- Number of replicas for the distributor
      replicas: 1
      # -- Resource requests and limits for the distributor
      resources: {}
      # -- Grace period to allow the distributor to shutdown before it is killed
      terminationGracePeriodSeconds: 30
      # -- Affinity for distributor pods. Passed through `tpl` and, thus, to be configured as string
      # @default -- Hard node and soft zone anti-affinity
      affinity: |
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "loki.distributorSelectorLabels" . | nindent 10 }}
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "loki.distributorSelectorLabels" . | nindent 12 }}
                topologyKey: failure-domain.beta.kubernetes.io/zone
      # -- Node selector for distributor pods
      nodeSelector: {}
      # -- Tolerations for distributor pods
      tolerations: []

    # Configuration for the querier
    querier:
      # -- Number of replicas for the querier
      replicas: 1
      # -- Resource requests and limits for the querier
      resources: {}
      # -- Grace period to allow the querier to shutdown before it is killed
      terminationGracePeriodSeconds: 30
      # -- Affinity for querier pods. Passed through `tpl` and, thus, to be configured as string
      # @default -- Hard node and soft zone anti-affinity
      affinity: |
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "loki.querierSelectorLabels" . | nindent 10 }}
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "loki.querierSelectorLabels" . | nindent 12 }}
                topologyKey: failure-domain.beta.kubernetes.io/zone
      # -- Node selector for querier pods
      nodeSelector: {}
      # -- Tolerations for querier pods
      tolerations: []
      persistence:
        # -- Enable creating PVCs for the querier cache
        enabled: false
        # -- Size of persistent disk
        size: 10Gi
        # -- Storage class to be used.
        # If defined, storageClassName: <storageClass>.
        # If set to "-", storageClassName: "", which disables dynamic provisioning.
        # If empty or set to null, no storageClassName spec is
        # set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack).
        storageClass: null

    # Configuration for the query-frontend
    queryFrontend:
      # -- Number of replicas for the query-frontend
      replicas: 1
      # -- Resource requests and limits for the query-frontend
      resources: {}
      # -- Grace period to allow the query-frontend to shutdown before it is killed
      terminationGracePeriodSeconds: 30
      # -- Affinity for query-frontend pods. Passed through `tpl` and, thus, to be configured as string
      # @default -- Hard node and soft zone anti-affinity
      affinity: |
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "loki.queryFrontendSelectorLabels" . | nindent 10 }}
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "loki.queryFrontendSelectorLabels" . | nindent 12 }}
                topologyKey: failure-domain.beta.kubernetes.io/zone
      # -- Node selector for query-frontend pods
      nodeSelector: {}
      # -- Tolerations for query-frontend pods
      tolerations: []

    # Configuration for the gateway
    gateway:
      # -- Specifies whether the gateway should be enabled
      enabled: true
      # -- Number of replicas for the gateway
      replicas: 1
      image:
        # -- The Docker registry for the gateway image
        registry: docker.io
        # -- The gateway image repository
        repository: nginxinc/nginx-unprivileged
        # -- The gateway image tag
        tag: 1.19-alpine
        # -- The gateway image pull policy
        pullPolicy: IfNotPresent
      # -- The name of the PriorityClass for gateway pods
      priorityClassName: null
      # -- Annotations for gateway pods
      podAnnotations: {}
      # -- Additional CLI args for the gateway
      extraArgs: []
      # -- Environment variables to add to the gateway pods
      extraEnv: []
      # -- Environment variables from secrets or configmaps to add to the gateway pods
      extraEnvFrom: []
      # -- Volumes to add to the gateway pods
      extraVolumes: []
      # -- Volume mounts to add to the gateway pods
      extraVolumeMounts: []
      # -- The SecurityContext for gateway containers
      podSecurityContext:
        fsGroup: 101
        runAsGroup: 101
        runAsNonRoot: true
        runAsUser: 101
      # -- The SecurityContext for gateway containers
      containerSecurityContext:
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
        allowPrivilegeEscalation: false
      # -- Resource requests and limits for the gateway
      resources: {}
      # -- Grace period to allow the gateway to shutdown before it is killed
      terminationGracePeriodSeconds: 30
      # -- Affinity for gateway pods. Passed through `tpl` and, thus, to be configured as string
      # @default -- Hard node and soft zone anti-affinity
      affinity: |
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  {{- include "loki.gatewaySelectorLabels" . | nindent 10 }}
              topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "loki.gatewaySelectorLabels" . | nindent 12 }}
                topologyKey: failure-domain.beta.kubernetes.io/zone
      # -- Node selector for gateway pods
      nodeSelector: {}
      # -- Tolerations for gateway pods
      tolerations: []
      # Gateway service configuration
      service:
        # -- Port of the gateway service
        port: 80
        # -- Type of the gateway service
        type: ClusterIP
        # -- ClusterIP of the gateway service
        clusterIP: null
        # -- Node port if service type is NodePort
        nodePort: null
        # -- Load balancer IPO address if service type is LoadBalancer
        loadBalancerIP: null
        # -- Annotations for the gateway service
        annotations: {}
      # Gateway ingress configuration
      ingress:
        # -- Specifies whether an ingress for the gateway should be created
        enabled: true
        # -- Annotations for the gateway ingress
        annotations:
          kubernetes.io/ingress.class: "internal-ingress"
          nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
          nginx.ingress.kubernetes.io/configuration-snippet: |
            if ($request_uri ~* \.(js|css|gif|jpe?g|png)) {
              expires 60m;
              add_header Cache-Control "public";
            } 
        # -- Hosts configuration for the gateway ingress
        hosts:
          - host: gateway.loki.wine.com
            paths:
              - /
        # -- TLS configuration for the gateway ingress
        tls: []
      # Basic auth configuration
      basicAuth:
        # -- Enables basic authentication for the gateway
        enabled: false
        # -- The basic auth username for the gateway
        username: null
        # -- The basic auth password for the gateway
        password: null
        # -- Uses the specified username and password to compute a htpasswd using Sprig's `htpasswd` function.
        # The value is templated using `tpl`. Override this to use a custom htpasswd, e.g. in case the default causes
        # high CPU load.
        htpasswd: >-
          {{ htpasswd (required "'gateway.basicAuth.username' is required" .Values.gateway.basicAuth.username) (required "'gateway.basicAuth.password' is required" .Values.gateway.basicAuth.password) }}
        # -- Existing basic auth secret to use. Must contain '.htpasswd'
        existingSecret: null
      # Configures the readiness probe for the gateway
      readinessProbe:
        httpGet:
          path: /
          port: http
        initialDelaySeconds: 15
        timeoutSeconds: 1
      nginxConfig:
        # -- NGINX log format
        logFormat: |-
          main '$remote_addr - $remote_user [$time_local]  $status '
                  '"$request" $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
        # -- Allows appending custom configuration to the server block
        serverSnippet: ""
        # -- Allows appending custom configuration to the http block
        httpSnippet: ""
        # -- Config file contents for Nginx. Passed through the `tpl` function to allow templating
        # @default -- See values.yaml
        file: |
          worker_processes  5;  ## Default: 1
          error_log  /dev/stderr;
          pid        /tmp/nginx.pid;
          worker_rlimit_nofile 8192;

          events {
            worker_connections  4096;  ## Default: 1024
          }

          http {
            client_body_temp_path /tmp/client_temp;
            proxy_temp_path       /tmp/proxy_temp_path;
            fastcgi_temp_path     /tmp/fastcgi_temp;
            uwsgi_temp_path       /tmp/uwsgi_temp;
            scgi_temp_path        /tmp/scgi_temp;

            default_type application/octet-stream;
            log_format   {{ .Values.gateway.nginxConfig.logFormat }}
            access_log   /dev/stderr  main;
            sendfile     on;
            tcp_nopush   on;
            resolver {{ .Values.global.dnsService }}.kube-system.svc.{{ .Values.global.clusterDomain }};

            {{- with .Values.gateway.nginxConfig.httpSnippet }}
            {{ . | nindent 2 }}
            {{- end }}

            server {
              listen             8080;

              {{- if .Values.gateway.basicAuth.enabled }}
              auth_basic           "Loki";
              auth_basic_user_file /etc/nginx/secrets/.htpasswd;
              {{- end }}

              location = / {
                return 200 'OK';
                auth_basic off;
              }

              location = /api/prom/push {
                proxy_pass       http://{{ include "loki.distributorFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
              }

              location = /api/prom/tail {
                proxy_pass       http://{{ include "loki.querierFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
              }

              location ~ /api/prom/.* {
                proxy_pass       http://{{ include "loki.queryFrontendFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
              }

              location = /loki/api/v1/push {
                proxy_pass       http://{{ include "loki.distributorFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
              }

              location = /loki/api/v1/tail {
                proxy_pass       http://{{ include "loki.querierFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
              }

              location ~ /loki/api/.* {
                proxy_pass       http://{{ include "loki.queryFrontendFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}:3100$request_uri;
              }

              {{- with .Values.gateway.nginxConfig.serverSnippet }}
              {{ . | nindent 4 }}
              {{- end }}
            }
          }

    # Configuration for the compactor
    compactor:
      # -- Specifies whether compactor should be enabled
      enabled: false
      image:
        # -- The Docker registry for the compactor image. Overrides `loki.image.registry`
        registry: null
        # -- Docker image repository for the compactor image. Overrides `loki.image.repository`
        repository: null
        # -- Docker image tag for the compactor image. Overrides `loki.image.tag`
        tag: null
      # -- The name of the PriorityClass for compactor pods
      priorityClassName: null
      # -- Annotations for compactor pods
      podAnnotations: {}
      # -- Additional CLI args for the compactor
      extraArgs: []
      # -- Environment variables to add to the compactor pods
      extraEnv: []
      # -- Environment variables from secrets or configmaps to add to the compactor pods
      extraEnvFrom: []
      # -- Volume mounts to add to the compactor pods
      extraVolumeMounts: []
      # -- Volumes to add to the compactor pods
      extraVolumes: []
      # -- Resource requests and limits for the compactor
      resources: {}
      # -- Grace period to allow the compactor to shutdown before it is killed
      terminationGracePeriodSeconds: 30
      # -- Node selector for compactor pods
      nodeSelector: {}
      # -- Tolerations for compactor pods
      tolerations: []
      persistence:
        # -- Enable creating PVCs for the compactor
        enabled: false
        # -- Size of persistent disk
        size: 10Gi
        # -- Storage class to be used.
        # If defined, storageClassName: <storageClass>.
        # If set to "-", storageClassName: "", which disables dynamic provisioning.
        # If empty or set to null, no storageClassName spec is
        # set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack).
        storageClass: null
