export GHUSER="tfrigini"

kubectl create ns flux

fluxctl install \
--git-user=${GHUSER} \
--git-email=${GHUSER}@users.noreply.github.com \
--git-url=git@github.com:${GHUSER}/fluxMigration \
--git-path=namespaces,workloads \
--git-branch=main \
--namespace=flux


fluxctl install \
--git-user=${GHUSER} \
--git-email=${GHUSER}@users.noreply.github.com \
--git-url=git@github.com:${GHUSER}/fluxMigration \
--git-path=kubernetes/clusters/hmg-dev \
--git-branch=main \
--namespace=flux


kubectl -n flux rollout status deployment/flux

fluxctl identity --k8s-fwd-ns flux

install flux v2:
# com componentes extras para automação de imagem!

flux bootstrap github \
  --components-extra=image-reflector-controller,image-automation-controller \
  --owner=$GITHUB_USER \
  --repository=flux-image-updates \
  --branch=main \
  --path=clusters/my-cluster \
  --token-auth \
  --personal

# realizar o deployment de uma aplicação podinfo (por exemplo)
flux create source git podinfo \
  --url=https://github.com/stefanprodan/podinfo \
  --branch=master \
  --interval=30s \
  --export > ./kubernetes/clusters/bifrost/releases/podinfo-4/podinfo-source.yaml

flux create kustomization podinfo \
  --source=podinfo \
  --path="./kustomize" \
  --prune=true \
  --validation=client \
  --interval=1m \
  --export > ./kubernetes/clusters/bifrost/releases/podinfo-4/podinfo-kustomization.yaml

# install KUTOMIZE CLI 
curl --silent --location --remote-name \
 "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v3.2.3/kustomize_kustomize.v3.2.3_linux_amd64" && \
 chmod a+x kustomize_kustomize.v3.2.3_linux_amd64 && \
 sudo mv kustomize_kustomize.v3.2.3_linux_amd64 /usr/local/bin/kustomize

# gerar kutomization.yaml 
kustomize create --autodetect --recursive

# depois disso é possivel rodar o seguinte comando para sincronizar o flux:

flux reconcile kustomization flux-system --with-source


# O flux 2 será instalado e após isso deve realizar a migração 
# gradual do helm-operator para o helm-controller através dos 
# arquivos
exemplos:


apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: podinfo-4
  namespace: app
  annotations:
    fluxcd.io/automated: "true"
    fluxcd.io/locked: "true"
spec:
  chart:
    repository: https://stefanprodan.github.io/podinfo
    name: podinfo
    version: 3.2.0 

---

apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: podinfo-2
  namespace: app
spec:
  # The interval at which to reconcile the Helm release
  interval: 2m
  chart:
    spec:
      # The name of the chart as made available by the HelmRepository
      # (without any aliases)
      chart: podinfo
      # A fixed SemVer, or any SemVer range
      # (i.e. >=4.0.0 <5.0.0)
      version: 3.2.0
      # The reference to the HelmRepository
      sourceRef:
        kind: HelmRepository
        name: podinfo-h3
        # Optional, defaults to the namespace of the HelmRelease
        namespace: default

# Após isso deve realizar a migração da automação de image

- verificar pre-requisitos:

flux check --components-extra=image-reflector-controller,image-automation-controller

- migrando cada manifesto:

flux create image repository podinfo-image \
    --image ghcr.io/beatrizafonso/podinfo \
    --interval 1m \
    --export > ./kubernetes/clusters/bifrost/releases/automation/podinfo-image.yaml

Esse comando vai criar um manifesto no caminho especificado;
Após isso commitar mudanças e sincronizar o flux e checar se está funcionando:

flux reconcile kustomization --with-source flux-system



